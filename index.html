<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FMS Status Overrides</title>

<style>
  :root{--bg:#0a0c10;--card:#0f1420;--text:#e6edf6;--muted:#93a4b7;--accent:#7c3aed;--accent2:#22d3ee;--ok:#10b981;--bad:#ef4444;--border:#1f2a3a}
  *{box-sizing:border-box}
  html,body{margin:0;background:radial-gradient(1200px 900px at 10% -10%, #121a2b 0%, transparent 60%), var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  .wrap{max-width:980px;margin:40px auto;padding:0 16px 64px}
  h1{margin:0 0 6px;font-size:26px;font-weight:800}
  .sub{color:var(--muted);margin-bottom:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  textarea{width:100%;min-height:220px;background:#0b0f19;border:1px solid var(--border);color:var(--text);border-radius:14px;padding:12px 14px;font-size:14px;line-height:1.4;resize:vertical;outline:none}
  pre{white-space:pre-wrap;word-break:break-word;background:#0b0f19;border:1px solid var(--border);border-radius:14px;padding:12px;font-size:14px;max-height:420px;overflow:auto}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{cursor:pointer;border:1px solid transparent;border-radius:14px;padding:12px 16px;font-weight:700;font-size:14px}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#060913}
  .btn-ghost{background:transparent;border-color:var(--border);color:var(--text)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .bar{height:12px;border-radius:999px;background:#0b0f19;border:1px solid var(--border);overflow:hidden}
  .fill{height:100%;width:0;background:linear-gradient(90deg,var(--ok),var(--accent2));transition:width .2s ease}
  .muted{color:var(--muted);font-size:12px}
  .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
</style>
</head>

<body>
<div class="wrap">
  <div class="hdr">
    <h1>FMS Status Overrides</h1>
  </div>

  <div class="card">
    <textarea id="input"></textarea>

    <div class="row">
      <button class="btn btn-ghost" id="preview">Check Order Info</button>
    </div>

    <div class="bar"><div class="fill" id="fill"></div></div>
    <div class="muted" id="status">Idle</div>
  </div>

  <div class="card" style="margin-top:16px">
    <pre id="out"></pre>
  </div>
</div>

<script>
const BASE = "https://fms.item.com";
const ORDER_BASIC_URL = `${BASE}/fms-platform-order/shipper/getshipment-orderbasic/`;
const ORDER_HEAD_URL  = `${BASE}/fms-platform-order/shipper/getshipment-orderbasic-headinfo/`;

const FMS_CLIENT="FMS_WEB";
const COMPANY_ID="SBFH";
const USERNAME="RaulEscobar";
const PASSWORD="FMSoffload1!";
const MAX_ORDERS=150;
const $=id=>document.getElementById(id);

let TOKEN=null;

async function auth(){
  if(TOKEN) return TOKEN;
  const r = await fetch(`${BASE}/fms-platform-user/Auth/Login`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({account:USERNAME,password:PASSWORD})
  });
  const j = await r.json();
  TOKEN = j.token;
  return TOKEN;
}

function parsePros(t){
  return (String(t).match(/\b\d{6,14}\b/g) || []);
}

function line(msg){ out.textContent += (out.textContent ? "\n" : "") + msg; }
function resetOutput(){ out.textContent=""; }

function clean(v){ return (v==null||v==="")?"-":String(v).trim(); }

$("preview").addEventListener("click", async ()=>{
  resetOutput();
  const pros = parsePros(input.value);
  if(!pros.length){ line("[Error] No PROs found."); return; }

  const token = await auth();
  const headers = {
    "accept":"application/json, text/plain, */*",
    "fms-client":FMS_CLIENT,
    "fms-token":token,
    "company-id":COMPANY_ID
  };

  for(const pro of pros){
    // Step 1: Get DO from search
    let DO=null;
    try{
      const search = await fetch(`https://fms.item.com/fms-platform-order/shipment-orders/query`,{
        method:"POST",
        headers:{...headers, "Content-Type":"application/json"},
        body:JSON.stringify({
          tracking_nos:[pro], page_number:1, page_size:1
        })
      });
      const j = await search.json();
      const items = j?.data?.items || j.items || [];
      if(items.length){
        DO = items[0].order_no || items[0].orderNo || null;
      }
    }catch(e){}

    if(!DO){ line(`${pro} -> (no DO found) ---`); continue; }

    // Step 2: Pull PU & location/status fields
    let loc=null, statusDesc=null, subStatus=null, pu="-";

    try{
      const r = await fetch(ORDER_BASIC_URL + DO, {headers});
      const j = await r.json();
      const root = j?.data || j;
      loc = root?.current_location;
      pu = root?.reference5 || "-";
    }catch(e){}

    try{
      const r2 = await fetch(ORDER_HEAD_URL + DO, {headers});
      const j2 = await r2.json();
      const root = j2?.data || j2;
      statusDesc = root?.order_status_describe;
      subStatus  = root?.order_sub_status_describe;
    }catch(e){}

    // FORMAT OUTPUT
    const WIDTH = { pro:12, pu:12, DO:16 };

    function pad(v,w){
      v = clean(v);
      return v.length>w ? v.slice(0,w) : v + " ".repeat(w-v.length);
    }

    const outLine =
      `PRO ${pad(pro,WIDTH.pro)} | PU ${pad(pu,WIDTH.pu)} -> ${pad(DO,WIDTH.DO)} | Loc: ${clean(loc)} | Status: ${clean(statusDesc)} | Substatus: ${clean(subStatus)} ---`;

    line(outLine);
  }

  $("status").textContent="Done";
});
</script>

</body>
</html>
